# å·¥ä½œæµåç§°ï¼šç”Ÿæˆè¡¨æƒ…åŒ…å…³é”®è¯
name: Generate Meme Keywords

# æƒé™é…ç½®ï¼šå®šä¹‰å·¥ä½œæµæ‰€éœ€çš„æƒé™
permissions:
  # å…è®¸å†™å…¥å†…å®¹ï¼Œç”¨äºæ¨é€æ›´æ”¹åˆ°ä»“åº“å’ŒWiki
  contents: write

# è§¦å‘æ¡ä»¶é…ç½®ï¼šå®šä¹‰ä½•æ—¶å¯åŠ¨æ­¤å·¥ä½œæµ
on:
  # 1. è®¡åˆ’ä»»åŠ¡ï¼šæ¯å¤©å‡Œæ™¨4ç‚¹è‡ªåŠ¨è¿è¡Œ
  schedule:
    # cronè¡¨è¾¾å¼ï¼šåˆ† æ—¶ æ—¥ æœˆ æ˜ŸæœŸ
    # æ¯å¤©UTCæ—¶é—´4:00è¿è¡Œï¼ˆæ³¨æ„ï¼šGitHub Actionsä½¿ç”¨UTCæ—¶é—´ï¼‰
    # å¯¹åº”åŒ—äº¬æ—¶é—´ï¼š12:00ï¼ˆUTC+8ï¼‰
    - cron: '0 4 * * *'
  
  # 2. æ‰‹åŠ¨è§¦å‘ï¼šå…è®¸åœ¨GitHub Actionsç•Œé¢æ‰‹åŠ¨è¿è¡Œæ­¤å·¥ä½œæµ
  workflow_dispatch:

# ä½œä¸šå®šä¹‰ï¼šå·¥ä½œæµåŒ…å«ä¸€ä¸ªåä¸ºbuildçš„ä½œä¸š
jobs:
  # ä½œä¸šåç§°ï¼šbuild
  build:
    # æŒ‡å®šè¿è¡Œç¯å¢ƒï¼šä½¿ç”¨æœ€æ–°ç‰ˆçš„Ubuntuç³»ç»Ÿ
    runs-on: ubuntu-latest

    # æ­¥éª¤å®šä¹‰ï¼šä½œä¸šåŒ…å«å¤šä¸ªé¡ºåºæ‰§è¡Œçš„æ­¥éª¤
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç ä»“åº“
      - name: Checkout repository
        # ä½¿ç”¨å®˜æ–¹checkoutåŠ¨ä½œï¼Œç‰ˆæœ¬v4
        uses: actions/checkout@v4
        with:
          # è·å–å®Œæ•´çš„gitå†å²è®°å½•ï¼Œä¾¿äºæ¯”è¾ƒæ–‡ä»¶å˜åŒ–
          fetch-depth: 0

      # æ­¥éª¤2ï¼šè®¾ç½®Pythonç¯å¢ƒ
      - name: Set up Python
        # ä½¿ç”¨å®˜æ–¹setup-pythonåŠ¨ä½œï¼Œç‰ˆæœ¬v5
        uses: actions/setup-python@v5
        with:
          # æŒ‡å®šPythonç‰ˆæœ¬ä¸º3.10
          python-version: '3.10'

      # æ­¥éª¤3ï¼šå®‰è£…ä¾èµ–
      - name: Install dependencies
        # è¿è¡Œå‘½ä»¤ï¼šå‡çº§pipåŒ…ç®¡ç†å™¨
        run: pip install --upgrade pip

      # æ­¥éª¤4ï¼šå¤‡ä»½å½“å‰çš„å…³é”®è¯æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      - name: Backup current meme_keywords.md if exists
        # è¿è¡Œbashå‘½ä»¤è¿›è¡Œæ–‡ä»¶å¤‡ä»½
        run: |
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f docs/meme_keywords.md ]; then
            # å­˜åœ¨åˆ™åˆ›å»ºå¤‡ä»½æ–‡ä»¶
            cp docs/meme_keywords.md docs/meme_keywords.md.backup
            echo "Backed up existing meme_keywords.md"
          else
            # ä¸å­˜åœ¨åˆ™è¾“å‡ºæç¤ºä¿¡æ¯
            echo "No existing meme_keywords.md found"
          fi

      # æ­¥éª¤5ï¼šè¿è¡Œå…³é”®è¯ç”Ÿæˆè„šæœ¬
      - name: Run meme_keywords.py
        # è¿è¡ŒPythonè„šæœ¬ç”Ÿæˆå…³é”®è¯æ–‡ä»¶
        run: python ./docs/meme_keywords.py

      # æ­¥éª¤6ï¼šæ£€æŸ¥å…³é”®è¯æ–‡ä»¶æ˜¯å¦å‘ç”Ÿå˜åŒ–
      - name: Check if meme_keywords.md changed
        # ä¸ºæ­¤æ­¥éª¤è®¾ç½®IDï¼Œä¾¿äºåç»­æ­¥éª¤å¼•ç”¨
        id: check_diff
        run: |
          # æ£€æŸ¥å¤‡ä»½æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f docs/meme_keywords.md.backup ]; then
            # æ²¡æœ‰å¤‡ä»½æ–‡ä»¶ï¼Œè¯´æ˜æ˜¯æ–°æ–‡ä»¶ï¼Œæ ‡è®°ä¸ºæœ‰å˜åŒ–
            echo "No backup file, this is a new file."
            echo "changed=true" >> $GITHUB_OUTPUT
          # ä½¿ç”¨cmpå‘½ä»¤æ¯”è¾ƒæ–°æ–‡ä»¶å’Œå¤‡ä»½æ–‡ä»¶
          elif cmp -s docs/meme_keywords.md docs/meme_keywords.md.backup; then
            # æ–‡ä»¶ç›¸åŒï¼Œæ— å˜åŒ–
            echo "No changes detected."
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            # æ–‡ä»¶ä¸åŒï¼Œæœ‰å˜åŒ–
            echo "Changes detected."
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      # æ­¥éª¤7ï¼šæ›´æ–°GitHub Wikiï¼ˆä»…å½“æ–‡ä»¶æœ‰å˜åŒ–æ—¶æ‰§è¡Œï¼‰
      - name: Update GitHub Wiki
        # æ¡ä»¶åˆ¤æ–­ï¼šåªæœ‰ä¸Šä¸€æ­¥æ£€æµ‹åˆ°å˜åŒ–æ—¶æ‰æ‰§è¡Œ
        if: steps.check_diff.outputs.changed == 'true'
        run: |
          # é…ç½®gitç”¨æˆ·ä¿¡æ¯ï¼ˆä½¿ç”¨GitHub Actionsæœºå™¨äººè´¦æˆ·ï¼‰
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # æ£€æŸ¥Wikiä»“åº“æ˜¯å¦å­˜åœ¨
          if git ls-remote https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/anyliew/meme_emoji.wiki.git &>/dev/null; then
            echo "Wiki repository exists, proceeding with update"
            
            # å…‹éš†Wikiä»“åº“åˆ°æœ¬åœ°
            git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/anyliew/meme_emoji.wiki.git wiki
            cd wiki
            
            # åœ¨Wikiä»“åº“ä¸­å†æ¬¡é…ç½®gitç”¨æˆ·ä¿¡æ¯
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            
            # åˆ—å‡ºå½“å‰Wikiç›®å½•ä¸­çš„æ–‡ä»¶ï¼ˆç”¨äºè°ƒè¯•ï¼‰
            echo "Current files in wiki:"
            ls -la
            
            # å¤åˆ¶ç”Ÿæˆçš„æ–‡æ¡£åˆ°Wikiç›®å½•ï¼Œä½¿ç”¨ä¸­æ–‡æ–‡ä»¶å
            cp ../docs/meme_keywords.md "emoji_list.md"
            echo "Copied meme_keywords.md to emoji_list.md"
            
            # æ˜¾ç¤ºæ–‡ä»¶å†…å®¹çš„å‰å‡ è¡Œï¼ˆç”¨äºè°ƒè¯•ï¼‰
            echo "First 10 lines of emoji_list.md:"
            head -10 "emoji_list.md"
            
            # æ·»åŠ æ–‡ä»¶åˆ°gitæš‚å­˜åŒº
            git add "emoji_list.md"
            
            # æ£€æŸ¥gitçŠ¶æ€ï¼ˆç”¨äºè°ƒè¯•ï¼‰
            echo "Git status:"
            git status
            
            # æ£€æŸ¥æš‚å­˜åŒºæ˜¯å¦æœ‰å˜åŒ–
            if git diff --cached --quiet; then
              # æ²¡æœ‰å˜åŒ–ï¼Œè¾“å‡ºæç¤º
              echo "No changes in wiki after staging"
            else
              # æœ‰å˜åŒ–ï¼Œæäº¤å¹¶æ¨é€
              echo "Changes detected, committing..."
              git commit -m "ğŸ¤– Auto-update è¡¨æƒ…åˆ—è¡¨"
              git push origin master
              echo "Wiki updated successfully"
            fi
          else
            # Wikiä»“åº“ä¸å­˜åœ¨ï¼Œè¾“å‡ºæç¤ºä¿¡æ¯
            echo "âš ï¸ Wiki repository does not exist yet."
            echo "Please create a Wiki page manually first by:"
            echo "1. Go to your GitHub repository"
            echo "2. Click on 'Wiki' tab"
            echo "3. Create a new page called 'è¡¨æƒ…åˆ—è¡¨'"
            echo "4. The workflow will automatically update it on the next run"
          fi

      # æ­¥éª¤8ï¼šæ¸…ç†å¤‡ä»½æ–‡ä»¶ï¼ˆæ— è®ºæˆåŠŸæˆ–å¤±è´¥éƒ½ä¼šæ‰§è¡Œï¼‰
      - name: Cleanup backup file
        # ä½¿ç”¨always()æ¡ä»¶ï¼Œç¡®ä¿æ­¤æ­¥éª¤æ€»æ˜¯æ‰§è¡Œ
        if: always()
        run: |
          # å¦‚æœå¤‡ä»½æ–‡ä»¶å­˜åœ¨ï¼Œåˆ™åˆ é™¤å®ƒ
          if [ -f docs/meme_keywords.md.backup ]; then
            rm docs/meme_keywords.md.backup
            echo "Cleaned up backup file"
          fi