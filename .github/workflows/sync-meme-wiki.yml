# å·¥ä½œæµåç§°ï¼šè¡¨æƒ…åŒ…WikiåŒæ­¥
name: Sync Meme Wiki

# æƒé™é…ç½®ï¼šå®šä¹‰å·¥ä½œæµæ‰€éœ€çš„æƒé™
permissions:
  # å…è®¸å†™å…¥å†…å®¹ï¼Œç”¨äºæ¨é€æ›´æ”¹åˆ°ä»“åº“å’ŒWiki
  contents: write

# è§¦å‘æ¡ä»¶é…ç½®ï¼šå®šä¹‰ä½•æ—¶å¯åŠ¨æ­¤å·¥ä½œæµ
on:
  # å½“å‘ç”Ÿæ¨é€äº‹ä»¶æ—¶è§¦å‘
  push:
    # æŒ‡å®šåˆ†æ”¯ï¼šä»…mainåˆ†æ”¯çš„æ¨é€ä¼šè§¦å‘
    branches:
      - "main"
    # æŒ‡å®šè·¯å¾„ï¼šä»…emojiç›®å½•ä¸‹çš„æ–‡ä»¶å˜æ›´ä¼šè§¦å‘
    paths:
      - "emoji/**"
  # æ·»åŠ æ‰‹åŠ¨è§¦å‘ï¼šå…è®¸åœ¨GitHub Actionsç•Œé¢æ‰‹åŠ¨è¿è¡Œæ­¤å·¥ä½œæµ
  workflow_dispatch:

# ä½œä¸šå®šä¹‰ï¼šå·¥ä½œæµåŒ…å«ä¸€ä¸ªåä¸ºbuildçš„ä½œä¸š
jobs:
  # ä½œä¸šåç§°ï¼šbuild
  build:
    # æŒ‡å®šè¿è¡Œç¯å¢ƒï¼šä½¿ç”¨æœ€æ–°ç‰ˆçš„Ubuntuç³»ç»Ÿ
    runs-on: ubuntu-latest

    # æ­¥éª¤å®šä¹‰ï¼šä½œä¸šåŒ…å«å¤šä¸ªé¡ºåºæ‰§è¡Œçš„æ­¥éª¤
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä¸»ä»“åº“ä»£ç 
      - name: Checkout main repository
        # ä½¿ç”¨å®˜æ–¹checkoutåŠ¨ä½œï¼Œç‰ˆæœ¬v4
        uses: actions/checkout@v4
        with:
          # è·å–å®Œæ•´çš„gitå†å²è®°å½•ï¼Œä¾¿äºæ¯”è¾ƒæ–‡ä»¶å˜åŒ–
          fetch-depth: 0

      # æ­¥éª¤2ï¼šæ£€å‡ºWikiä»“åº“
      - name: Checkout wiki repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}.wiki
          path: wiki

      # æ­¥éª¤3ï¼šè®¾ç½®Pythonç¯å¢ƒ
      - name: Set up Python
        # ä½¿ç”¨å®˜æ–¹setup-pythonåŠ¨ä½œï¼Œç‰ˆæœ¬v4
        uses: actions/setup-python@v5
        with:
          # æŒ‡å®šPythonç‰ˆæœ¬ä¸º3.10
          python-version: '3.10'

      # æ­¥éª¤4ï¼šå®‰è£…ç³»ç»Ÿä¾èµ–
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-color-emoji libgl1 libglx-mesa0 libgl1-mesa-dri libegl1 libegl-mesa0
          # å®‰è£…å­—ä½“
          sudo mkdir -p /usr/share/fonts/myfonts
          sudo cp resources/fonts/* /usr/share/fonts/myfonts/ 2>/dev/null || echo "No custom fonts found"
          fc-cache -fv

      # æ­¥éª¤5ï¼šå®‰è£…Pythonä¾èµ–
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          # å®‰è£…meme_generatorï¼ˆå¯é€‰ï¼Œå¦‚æœéœ€è¦ï¼‰
          # pip install -U "meme_generator<0.2.0" filetype pillow

      # æ­¥éª¤6ï¼šå¤‡ä»½å½“å‰çš„å…³é”®è¯æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      - name: Backup current meme_keywords.md if exists
        # è¿è¡Œbashå‘½ä»¤è¿›è¡Œæ–‡ä»¶å¤‡ä»½
        run: |
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f docs/meme_keywords.md ]; then
            # å­˜åœ¨åˆ™åˆ›å»ºå¤‡ä»½æ–‡ä»¶
            cp docs/meme_keywords.md docs/meme_keywords.md.backup
            echo "Backed up existing meme_keywords.md"
          else
            # ä¸å­˜åœ¨åˆ™è¾“å‡ºæç¤ºä¿¡æ¯
            echo "No existing meme_keywords.md found"
          fi

      # æ­¥éª¤7ï¼šè¿è¡Œå…³é”®è¯ç”Ÿæˆè„šæœ¬
      - name: Run meme_keywords.py
        # è¿è¡ŒPythonè„šæœ¬ç”Ÿæˆå…³é”®è¯æ–‡ä»¶
        run: python ./docs/meme_keywords.py

      # æ­¥éª¤8ï¼šæ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°Wikiè„šæœ¬
      - name: Check for wiki update script
        id: check_wiki_script
        run: |
          # æ£€æŸ¥æ˜¯å¦å­˜åœ¨Wikiæ›´æ–°è„šæœ¬
          if [ -f wiki/update_meme_list.py ]; then
            echo "wiki_update_script=true" >> $GITHUB_OUTPUT
            echo "Found wiki update script"
          else
            echo "wiki_update_script=false" >> $GITHUB_OUTPUT
            echo "No wiki update script found"
          fi

      # æ­¥éª¤9ï¼šè¿è¡ŒWikiæ›´æ–°è„šæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      - name: Run wiki update script
        if: steps.check_wiki_script.outputs.wiki_update_script == 'true'
        run: |
          cd wiki
          python3 update_meme_list.py
          cd ..

      # æ­¥éª¤10ï¼šæ£€æŸ¥å…³é”®è¯æ–‡ä»¶æ˜¯å¦å‘ç”Ÿå˜åŒ–
      - name: Check if meme_keywords.md changed
        # ä¸ºæ­¤æ­¥éª¤è®¾ç½®IDï¼Œä¾¿äºåç»­æ­¥éª¤å¼•ç”¨
        id: check_diff
        run: |
          # æ£€æŸ¥å¤‡ä»½æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f docs/meme_keywords.md.backup ]; then
            # æ²¡æœ‰å¤‡ä»½æ–‡ä»¶ï¼Œè¯´æ˜æ˜¯æ–°æ–‡ä»¶ï¼Œæ ‡è®°ä¸ºæœ‰å˜åŒ–
            echo "No backup file, this is a new file."
            echo "changed=true" >> $GITHUB_OUTPUT
          # ä½¿ç”¨cmpå‘½ä»¤æ¯”è¾ƒæ–°æ–‡ä»¶å’Œå¤‡ä»½æ–‡ä»¶
          elif cmp -s docs/meme_keywords.md docs/meme_keywords.md.backup; then
            # æ–‡ä»¶ç›¸åŒï¼Œæ— å˜åŒ–
            echo "No changes detected."
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            # æ–‡ä»¶ä¸åŒï¼Œæœ‰å˜åŒ–
            echo "Changes detected."
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      # æ­¥éª¤11ï¼šæ›´æ–°GitHub Wikiï¼ˆä»…å½“æ–‡ä»¶æœ‰å˜åŒ–æ—¶æ‰§è¡Œï¼‰
      - name: Update GitHub Wiki
        # æ¡ä»¶åˆ¤æ–­ï¼šåªæœ‰æ£€æµ‹åˆ°å˜åŒ–æ—¶æ‰æ‰§è¡Œ
        if: steps.check_diff.outputs.changed == 'true' || steps.check_wiki_script.outputs.wiki_update_script == 'true'
        run: |
          # é…ç½®gitç”¨æˆ·ä¿¡æ¯ï¼ˆä½¿ç”¨GitHub Actionsæœºå™¨äººè´¦æˆ·ï¼‰
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          cd wiki
          
          # åœ¨Wikiä»“åº“ä¸­å†æ¬¡é…ç½®gitç”¨æˆ·ä¿¡æ¯
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # å¤åˆ¶ç”Ÿæˆçš„æ–‡æ¡£åˆ°Wikiç›®å½•
          if [ -f ../docs/meme_keywords.md ]; then
            cp ../docs/meme_keywords.md "emoji_list.md"
            echo "Copied meme_keywords.md to emoji_list.md"
          fi
          
          # åˆ—å‡ºå½“å‰Wikiç›®å½•ä¸­çš„æ–‡ä»¶ï¼ˆç”¨äºè°ƒè¯•ï¼‰
          echo "Current files in wiki:"
          ls -la
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶éœ€è¦æäº¤
          if [ -n "$(git status --porcelain)" ]; then
            # æœ‰å˜åŒ–ï¼Œæ·»åŠ æ‰€æœ‰æ–‡ä»¶
            git add .
            
            # æ£€æŸ¥gitçŠ¶æ€ï¼ˆç”¨äºè°ƒè¯•ï¼‰
            echo "Git status:"
            git status
            
            # æäº¤å¹¶æ¨é€
            echo "Changes detected, committing..."
            git commit -m "ğŸ¤– Auto-update è¡¨æƒ…åˆ—è¡¨"
            git push origin master
            echo "Wiki updated successfully"
          else
            # æ²¡æœ‰å˜åŒ–ï¼Œè¾“å‡ºæç¤º
            echo "No changes to commit in wiki"
          fi

      # æ­¥éª¤12ï¼šæ¸…ç†å¤‡ä»½æ–‡ä»¶ï¼ˆæ— è®ºæˆåŠŸæˆ–å¤±è´¥éƒ½ä¼šæ‰§è¡Œï¼‰
      - name: Cleanup backup file
        # ä½¿ç”¨always()æ¡ä»¶ï¼Œç¡®ä¿æ­¤æ­¥éª¤æ€»æ˜¯æ‰§è¡Œ
        if: always()
        run: |
          # å¦‚æœå¤‡ä»½æ–‡ä»¶å­˜åœ¨ï¼Œåˆ™åˆ é™¤å®ƒ
          if [ -f docs/meme_keywords.md.backup ]; then
            rm docs/meme_keywords.md.backup
            echo "Cleaned up backup file"
          fi